<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WIDE - Browser Python IDE</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

<style>
body{margin:0;background:#0b0f14;color:white;font-family:Segoe UI;}

#topbar{
  background:#111;
  padding:15px;
  font-size:22px;
  text-align:center;
  border-bottom:2px solid #00f7ff;
  text-shadow:0 0 8px #00f7ff;
}

#toolbar{
  display:flex;
  justify-content:center;
  gap:15px;
  padding:10px;
  background:#111;
  border-bottom:1px solid #222;
  position:relative;
}

button{
  padding:8px 18px;
  background:#1a1a1a;
  color:white;
  border:1px solid #333;
  border-radius:8px;
  cursor:pointer;
  transition:0.2s;
}
button:hover{
  border-color:#00f7ff;
  color:#00f7ff;
  box-shadow:0 0 8px #00f7ff;
}

.dropdown{
  position:absolute;
  top:100%;
  left:0;
  background:#111;
  border:1px solid #333;
  display:none;
  flex-direction:column;
  min-width:180px;
  z-index:200;
}
.dropdown.show{display:flex;}
.dropdown button{
  background:#111;
  border:none;
  border-bottom:1px solid #222;
  text-align:left;
  padding:8px 12px;
  border-radius:0;
}
.dropdown button:hover{background:#1a1a1a;color:#00f7ff;}

#main{
  display:flex;
  height:85vh;
}

#editorContainer{
  width:50%;
  height:100%;
}

#divider{
  width:5px;
  cursor:col-resize;
  background:#00f7ff;
}

#outputContainer{
  width:50%;
  background:#000;
  padding:15px;
  overflow-y:auto;
  font-family:monospace;
  color:#00ff88;
  box-shadow:inset 0 0 20px #00ff8855;
}

.output-line{margin-bottom:4px;}
.error{color:#ff4c4c;}

.input-line{
  display:flex;
  align-items:center;
  margin-top:4px;
}

.prompt{
  margin-right:6px;
  color:#00f7ff;
}

.terminal-input{
  background:black;
  border:none;
  outline:none;
  color:#00ff88;
  font-family:monospace;
  flex:1;
}

.blinking-cursor::after{
  content:"|";
  animation:blink 1s infinite;
}

@keyframes blink{
  0%{opacity:1;}
  50%{opacity:0;}
  100%{opacity:1;}
}

.loading{
  animation:spin 1s linear infinite;
}
@keyframes spin{
  from{transform:rotate(0deg);}
  to{transform:rotate(360deg);}
}

#authScreen{
  position:fixed;
  inset:0;
  background:#111;
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:100;
}

#authBox{
  background:#000;
  padding:30px;
  border-radius:20px;
  text-align:center;
  width:320px;
  box-shadow:0 0 20px #00f7ff55;
}

#authBox p{
  font-size:14px;
  color:#aaa;
}

input{
  width:90%;
  padding:8px;
  margin:8px 0;
  background:#111;
  border:1px solid #333;
  color:white;
}
</style>
</head>
<body>

<div id="authScreen">
  <div id="authBox">
    <h2>Login / Sign Up</h2>
    <p>You can only access and save files if you log in or sign up.</p>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <br>
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
    <button onclick="guest()">Use as Guest</button>
    <p id="authMessage"></p>
  </div>
</div>

<div id="topbar">WIDE - Python IDE</div>

<div id="toolbar">
  <button id="runBtn" onclick="runCode()">Run</button>
  <button onclick="newFile()">New</button>
  <button onclick="copyCode()">Copy</button>
  <button id="saveBtn" onclick="saveFile()" style="display:none;">Save</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="main">
  <div id="editorContainer">
    <textarea id="code">print("Welcome to WIDE!")</textarea>
  </div>
  <div id="divider"></div>
  <div id="outputContainer"></div>
</div>

<script>
let editor=CodeMirror.fromTextArea(document.getElementById("code"),{
  mode:"python",
  theme:"dracula",
  lineNumbers:true
});

let outputContainer=document.getElementById("outputContainer");
let runBtn=document.getElementById("runBtn");
let saveBtn=document.getElementById("saveBtn");
let toolbar=document.getElementById("toolbar");
let currentUser=null;

/* MASTER ACCOUNT */
const MASTER_ACCOUNT="Willspurs21";
const MASTER_PASSWORD="Will_spurs21";

/* DRAG RESIZE */
let divider=document.getElementById("divider");
divider.addEventListener("mousedown",()=>{
  document.addEventListener("mousemove",resize);
  document.addEventListener("mouseup",()=>document.removeEventListener("mousemove",resize));
});
function resize(e){
  let percent=e.clientX/window.innerWidth*100;
  document.getElementById("editorContainer").style.width=percent+"%";
  outputContainer.style.width=(100-percent)+"%";
}

/* HASH */
async function hash(text){
  const encoder=new TextEncoder();
  const data=encoder.encode(text);
  const hashBuffer=await crypto.subtle.digest("SHA-256",data);
  return Array.from(new Uint8Array(hashBuffer))
    .map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* AUTH */
async function signup(){
  let user=username.value.trim();
  let pass=password.value.trim();
  if(!user||!pass)return;
  if(localStorage.getItem("user_"+user)){
    authMessage.innerText="User exists.";
    return;
  }
  localStorage.setItem("user_"+user,await hash(pass));
  authMessage.innerText="Signup successful!";
}

async function login(){
  let user=username.value.trim();
  let pass=password.value.trim();
  if(user===MASTER_ACCOUNT && pass===MASTER_PASSWORD){
    currentUser=user;
    localStorage.setItem("session",user);
    startIDE(true);
    return;
  }

  let stored=localStorage.getItem("user_"+user);
  if(!stored){authMessage.innerText="No account.";return;}
  if(stored!==await hash(pass)){authMessage.innerText="Wrong password.";return;}
  currentUser=user;
  localStorage.setItem("session",user);
  startIDE(false);
}

function guest(){currentUser="guest";startIDE(false);}
function logout(){localStorage.removeItem("session");location.reload();}
function startIDE(isMaster){
  authScreen.style.display="none";
  if(currentUser!=="guest") saveBtn.style.display="inline-block";

  // add master admin button if needed
  if(isMaster){
    let adminBtn=document.createElement("button");
    adminBtn.id="adminBtn";
    adminBtn.textContent="Other Users";
    toolbar.appendChild(adminBtn);

    let dropdown=document.createElement("div");
    dropdown.className="dropdown";
    toolbar.appendChild(dropdown);

    adminBtn.addEventListener("click",()=>{
      dropdown.classList.toggle("show");
      dropdown.innerHTML=""; // refresh

      for(let i=0;i<localStorage.length;i++){
        let key=localStorage.key(i);
        if(key.startsWith("user_") && key!=="user_"+MASTER_ACCOUNT){
          let usernameBtn=document.createElement("button");
          usernameBtn.textContent=key.replace("user_","");
          usernameBtn.addEventListener("click",()=>{
            // toggle files list
            if(usernameBtn.nextSibling && usernameBtn.nextSibling.classList.contains("dropdown")){
              usernameBtn.nextSibling.remove();
              return;
            }
            let filesDiv=document.createElement("div");
            filesDiv.className="dropdown";
            filesDiv.style.background="#222";
            for(let j=0;j<localStorage.length;j++){
              let k=localStorage.key(j);
              if(k.startsWith("file_"+usernameBtn.textContent+"_")){
                let fileBtn=document.createElement("button");
                fileBtn.textContent=k.replace("file_"+usernameBtn.textContent+"_","");
                filesDiv.appendChild(fileBtn);
              }
            }
            usernameBtn.parentNode.insertBefore(filesDiv, usernameBtn.nextSibling);
          });
          dropdown.appendChild(usernameBtn);
        }
      }
    });
  }
}

window.onload=function(){
  let s=localStorage.getItem("session");
  if(s){
    if(s===MASTER_ACCOUNT){
      currentUser=s;
      startIDE(true);
    } else {
      currentUser=s;
      startIDE(false);
    }
  }
};

/* RUN */
function runCode(){
  runBtn.classList.add("loading");
  outputContainer.innerHTML="";

  function print(text){
    let div=document.createElement("div");
    div.className="output-line";
    div.textContent=text;
    outputContainer.appendChild(div);
    outputContainer.scrollTop=outputContainer.scrollHeight;
  }

  function printError(text){
    let div=document.createElement("div");
    div.className="output-line error";
    div.textContent=text;
    outputContainer.appendChild(div);
  }

  Sk.configure({
    output:print,
    read:x=>{
      if(!Sk.builtinFiles||!Sk.builtinFiles["files"][x])
        throw "File not found: '"+x+"'";
      return Sk.builtinFiles["files"][x];
    },
    inputfun:promptText=>{
      print(promptText);
      return new Promise(resolve=>{
        let line=document.createElement("div");
        line.className="input-line";

        let prompt=document.createElement("span");
        prompt.className="prompt";
        prompt.textContent=">>>";

        let input=document.createElement("input");
        input.className="terminal-input blinking-cursor";

        line.appendChild(prompt);
        line.appendChild(input);
        outputContainer.appendChild(line);
        input.focus();

        input.addEventListener("keydown",function(e){
          if(e.key==="Enter"){
            input.classList.remove("blinking-cursor");
            input.disabled=true;
            resolve(input.value);
          }
        });
      });
    },
    inputfunTakesPrompt:true
  });

  Sk.misceval.asyncToPromise(()=>{
    return Sk.importMainWithBody("<stdin>",false,editor.getValue(),true);
  }).catch(err=>printError(err.toString()))
  .finally(()=>runBtn.classList.remove("loading"));
}

function newFile(){editor.setValue("");}
function copyCode(){navigator.clipboard.writeText(editor.getValue());alert("Copied!");}
function saveFile(){alert("Save system ready for expansion.");}
</script>
</body>
</html>
