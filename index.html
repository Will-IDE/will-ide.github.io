<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WIDE - Browser Python IDE</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/theme/dracula.min.css">

<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.13/mode/python/python.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/skulpt@1.2.0/dist/skulpt-stdlib.js"></script>

<style>
body{margin:0;background:#0b0f14;color:white;font-family:Segoe UI;}
#topbar{
  background:#111;padding:15px;font-size:22px;text-align:center;
  border-bottom:2px solid #00f7ff;text-shadow:0 0 8px #00f7ff;
}
#toolbar{
  display:flex;justify-content:center;gap:15px;
  padding:10px;background:#111;border-bottom:1px solid #222;
  position:relative;
}
button{
  padding:8px 18px;background:#1a1a1a;color:white;
  border:1px solid #333;border-radius:8px;cursor:pointer;
  transition:0.2s;
}
button:hover{
  border-color:#00f7ff;color:#00f7ff;
  box-shadow:0 0 8px #00f7ff;
}
.dropdown{
  position:absolute;top:100%;background:#111;border:1px solid #333;
  display:none;flex-direction:column;min-width:200px;z-index:200;
}
.dropdown.show{display:flex;}
.dropdown button{
  background:#111;border:none;border-bottom:1px solid #222;
  text-align:left;padding:8px 12px;border-radius:0;
}
.dropdown button:hover{background:#1a1a1a;color:#00f7ff;}
#main{display:flex;height:85vh;}
#editorContainer{width:50%;}
#divider{width:5px;cursor:col-resize;background:#00f7ff;}
#outputContainer{
  width:50%;background:#000;padding:15px;
  overflow-y:auto;font-family:monospace;color:#00ff88;
}
.output-line{margin-bottom:4px;}
.error{color:#ff4c4c;}
.input-line{display:flex;margin-top:4px;}
.prompt{margin-right:6px;color:#00f7ff;}
.terminal-input{
  background:black;border:none;outline:none;
  color:#00ff88;font-family:monospace;flex:1;
}
#authScreen{
  position:fixed;inset:0;background:#111;
  display:flex;justify-content:center;align-items:center;
}
#authBox{
  background:#000;padding:30px;border-radius:20px;
  text-align:center;width:320px;
}
input{
  width:90%;padding:8px;margin:8px 0;
  background:#111;border:1px solid #333;color:white;
}
</style>
</head>
<body>

<div id="authScreen">
  <div id="authBox">
    <h2>Login / Sign Up</h2>
    <p>You can only access and save files if you log in or sign up.</p>
    <input id="username" placeholder="Username">
    <input id="password" type="password" placeholder="Password">
    <br>
    <button onclick="login()">Login</button>
    <button onclick="signup()">Sign Up</button>
    <button onclick="guest()">Use as Guest</button>
    <p id="authMessage"></p>
  </div>
</div>

<div id="topbar">WIDE - Python IDE</div>

<div id="toolbar">
  <button id="runBtn" onclick="runCode()">Run</button>
  <button onclick="newFile()">New</button>
  <button onclick="copyCode()">Copy</button>
  <button id="saveBtn" onclick="saveFile()" style="display:none;">Save</button>
  <button onclick="logout()">Logout</button>
</div>

<div id="main">
  <div id="editorContainer">
    <textarea id="code">print("Welcome to WIDE!")</textarea>
  </div>
  <div id="divider"></div>
  <div id="outputContainer"></div>
</div>

<script>
let editor=CodeMirror.fromTextArea(document.getElementById("code"),{
  mode:"python",theme:"dracula",lineNumbers:true
});
let outputContainer=document.getElementById("outputContainer");
let toolbar=document.getElementById("toolbar");
let saveBtn=document.getElementById("saveBtn");
let currentUser=null;

const MASTER_ACCOUNT="Willspurs21";
const MASTER_PASSWORD="Will_spurs21";

/* RESIZE */
divider.onmousedown=function(){
  document.onmousemove=function(e){
    let percent=e.clientX/window.innerWidth*100;
    editorContainer.style.width=percent+"%";
    outputContainer.style.width=(100-percent)+"%";
  }
  document.onmouseup=function(){document.onmousemove=null;}
}

/* HASH */
async function hash(text){
  const enc=new TextEncoder().encode(text);
  const buf=await crypto.subtle.digest("SHA-256",enc);
  return Array.from(new Uint8Array(buf))
  .map(b=>b.toString(16).padStart(2,'0')).join('');
}

/* AUTH */
async function signup(){
  let user=username.value.trim();
  let pass=password.value.trim();
  if(!user||!pass)return;
  if(localStorage.getItem("user_"+user)){
    authMessage.innerText="User exists.";return;
  }
  localStorage.setItem("user_"+user,await hash(pass));
  authMessage.innerText="Signup successful!";
}

async function login(){
  let user=username.value.trim();
  let pass=password.value.trim();
  if(user===MASTER_ACCOUNT&&pass===MASTER_PASSWORD){
    currentUser=user;startIDE(true);return;
  }
  let stored=localStorage.getItem("user_"+user);
  if(!stored){authMessage.innerText="No account.";return;}
  if(stored!==await hash(pass)){
    authMessage.innerText="Wrong password.";return;
  }
  currentUser=user;startIDE(false);
}
function guest(){currentUser="guest";startIDE(false);}
function logout(){location.reload();}

function startIDE(isMaster){
  authScreen.style.display="none";
  if(currentUser!=="guest") saveBtn.style.display="inline-block";

  /* FILES BUTTON */
  if(currentUser!=="guest"){
    let filesBtn=document.createElement("button");
    filesBtn.textContent="Files";
    toolbar.insertBefore(filesBtn,saveBtn);

    let drop=document.createElement("div");
    drop.className="dropdown";
    toolbar.appendChild(drop);

    filesBtn.onclick=function(){
      drop.classList.toggle("show");
      drop.innerHTML="";

      let add=document.createElement("button");
      add.textContent="Add Code";
      add.onclick=()=>editor.setValue("");
      drop.appendChild(add);

      let view=document.createElement("button");
      view.textContent="View Files";
      view.onclick=function(){
        drop.innerHTML="";
        for(let i=0;i<localStorage.length;i++){
          let k=localStorage.key(i);
          if(k.startsWith("file_"+currentUser+"_")){
            let fileBtn=document.createElement("button");
            fileBtn.textContent=k.replace("file_"+currentUser+"_","");
            fileBtn.onclick=()=>editor.setValue(localStorage.getItem(k));
            drop.appendChild(fileBtn);
          }
        }
      }
      drop.appendChild(view);
    }
  }

  /* ADMIN BUTTON */
  if(isMaster){
    let admin=document.createElement("button");
    admin.textContent="Other Users";
    toolbar.appendChild(admin);

    let drop=document.createElement("div");
    drop.className="dropdown";
    toolbar.appendChild(drop);

    admin.onclick=function(){
      drop.classList.toggle("show");
      drop.innerHTML="";
      for(let i=0;i<localStorage.length;i++){
        let k=localStorage.key(i);
        if(k.startsWith("user_")&&k!=="user_"+MASTER_ACCOUNT){
          let userBtn=document.createElement("button");
          let uname=k.replace("user_","");
          userBtn.textContent=uname;
          userBtn.onclick=function(){
            for(let j=0;j<localStorage.length;j++){
              let f=localStorage.key(j);
              if(f.startsWith("file_"+uname+"_")){
                let fileBtn=document.createElement("button");
                fileBtn.textContent="â†³ "+f.replace("file_"+uname+"_","");
                fileBtn.onclick=()=>editor.setValue(localStorage.getItem(f));
                drop.appendChild(fileBtn);
              }
            }
          }
          drop.appendChild(userBtn);
        }
      }
    }
  }
}

/* SAVE */
function saveFile(){
  if(currentUser==="guest"){
    alert("Guests cannot save files.");return;
  }
  let name=prompt("Enter file name:");
  if(!name||name.trim()===""){
    alert("Invalid file name.");return;
  }
  localStorage.setItem(
    "file_"+currentUser+"_"+name.trim(),
    editor.getValue()
  );
  alert("File saved successfully!");
}

/* IDE FEATURES */
function newFile(){editor.setValue("");}
function copyCode(){navigator.clipboard.writeText(editor.getValue());alert("Copied!");}

function runCode(){
  outputContainer.innerHTML="";
  Sk.configure({
    output:text=>{
      let div=document.createElement("div");
      div.className="output-line";
      div.textContent=text;
      outputContainer.appendChild(div);
    },
    read:x=>{
      if(!Sk.builtinFiles||!Sk.builtinFiles["files"][x])
        throw "File not found: '"+x+"'";
      return Sk.builtinFiles["files"][x];
    }
  });
  Sk.misceval.asyncToPromise(()=>{
    return Sk.importMainWithBody("<stdin>",false,editor.getValue(),true);
  }).catch(err=>{
    let div=document.createElement("div");
    div.className="output-line error";
    div.textContent=err.toString();
    outputContainer.appendChild(div);
  });
}
</script>
</body>
</html>
