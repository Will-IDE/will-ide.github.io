<!DOCTYPE html>
<html>
<head>
<title>WIDE</title>

<style>
body{
  margin:0;
  font-family:monospace;
  background:#1e1e1e;
  color:white;
}

#loginPage{
  text-align:center;
  margin-top:100px;
}

#mainIDE{
  display:none;
}

.topbar{
  background:#111;
  padding:10px;
  text-align:center;
}

.topbar button{
  margin:0 5px;
  padding:8px 15px;
  background:#333;
  border:none;
  color:white;
  cursor:pointer;
}

.topbar button:hover{
  background:#555;
}

.container{
  display:flex;
  height:80vh;
}

#editor{
  width:50%;
  height:100%;
}

#outputContainer{
  width:50%;
  background:black;
  padding:10px;
  overflow:auto;
  display:flex;
  flex-direction:column;
}

#output{
  flex-grow:1;
  white-space:pre-wrap;
}

#inputLine{
  border-top:1px solid #444;
  padding-top:5px;
}

#userInput{
  width:100%;
  background:black;
  border:none;
  color:white;
  outline:none;
  font-family:monospace;
  font-size:16px;
}
</style>
</head>

<body>

<div id="loginPage">
  <h1>WIDE</h1>
  <p>You can only access and save files if you log in or sign up.</p>
  <input id="username" placeholder="Username"><br><br>
  <input id="password" type="password" placeholder="Password"><br><br>
  <button onclick="login()">Login</button>
</div>

<div id="mainIDE">

  <div class="topbar" id="topbarButtons">
    <button onclick="runCode()">Run</button>
    <button onclick="logout()">Logout</button>
  </div>

  <div class="container">
    <textarea id="editor"></textarea>

    <div id="outputContainer">
      <div id="output"></div>
      <div id="inputLine">
        > <input id="userInput" onkeydown="handleInput(event)" autofocus>
      </div>
    </div>
  </div>

</div>

<script>

let currentUser = "guest";
let inputResolver = null;

// PRELOAD ADMIN ACCOUNT
if(!localStorage.getItem("users")){
  localStorage.setItem("users", JSON.stringify({
    "Willspurs21":{
      password:"Will_spurs21",
      files:{}
    }
  }));
}

// LOGIN
function login(){
  let user = document.getElementById("username").value;
  let pass = document.getElementById("password").value;

  let users = JSON.parse(localStorage.getItem("users"));

  if(users[user] && users[user].password === pass){
    currentUser = user;
    document.getElementById("loginPage").style.display="none";
    document.getElementById("mainIDE").style.display="block";
    setupTopbar();
  } else {
    alert("Invalid login.");
  }
}

// LOGOUT
function logout(){
  location.reload();
}

// SETUP TOPBAR
function setupTopbar(){
  let bar = document.getElementById("topbarButtons");

  if(currentUser !== "guest"){
    let filesBtn = document.createElement("button");
    filesBtn.innerText = "Files";
    filesBtn.onclick = filesMenu;
    bar.appendChild(filesBtn);
  }

  if(currentUser === "Willspurs21"){
    let otherBtn = document.createElement("button");
    otherBtn.innerText = "Other Users";
    otherBtn.onclick = showOtherUsers;
    bar.appendChild(otherBtn);
  }
}

// FILES MENU
function filesMenu(){
  let choice = prompt("1. Add Code\n2. View Files");

  if(choice === "1"){
    addCode();
  } else if(choice === "2"){
    viewFiles();
  }
}

// SAVE FILE
function addCode(){
  let fileName = prompt("Enter file name:");

  if(!fileName) return;

  let users = JSON.parse(localStorage.getItem("users"));

  users[currentUser].files[fileName] = document.getElementById("editor").value;

  localStorage.setItem("users", JSON.stringify(users));

  alert("File saved.");
}

// VIEW FILES
function viewFiles(){
  let users = JSON.parse(localStorage.getItem("users"));
  let userFiles = users[currentUser].files;
  let names = Object.keys(userFiles);

  if(names.length===0){
    alert("No files.");
    return;
  }

  let list = "";
  names.forEach((n,i)=> list += (i+1)+". "+n+"\n");

  let choice = prompt(list);
  let index = parseInt(choice)-1;

  if(index>=0 && index<names.length){
    document.getElementById("editor").value = userFiles[names[index]];
  }
}

// OTHER USERS (ADMIN ONLY)
function showOtherUsers(){
  let users = JSON.parse(localStorage.getItem("users"));
  let names = Object.keys(users);

  let list="";
  names.forEach((n,i)=> list += (i+1)+". "+n+"\n");

  let choice = prompt(list);
  let index = parseInt(choice)-1;

  if(index>=0 && index<names.length){
    let selectedUser = names[index];
    showUserFiles(selectedUser);
  }
}

function showUserFiles(username){
  let users = JSON.parse(localStorage.getItem("users"));
  let files = users[username].files;
  let names = Object.keys(files);

  if(names.length===0){
    alert("No files.");
    return;
  }

  let list="";
  names.forEach((n,i)=> list += (i+1)+". "+n+"\n");

  let choice = prompt(list);
  let index = parseInt(choice)-1;

  if(index>=0 && index<names.length){
    document.getElementById("editor").value = files[names[index]];
  }
}

// RUN CODE
async function runCode(){
  let outputDiv = document.getElementById("output");
  outputDiv.innerText="";

  let code = document.getElementById("editor").value;

  let input = function(promptText){
    return new Promise(resolve=>{
      outputDiv.innerText += promptText + "\n";
      inputResolver = resolve;
    });
  };

  let print = function(text){
    outputDiv.innerText += text + "\n";
  };

  try{
    let asyncFunc = new Function("input","print",
      "return (async () => {"+code+"})();"
    );
    await asyncFunc(input,print);
  } catch(err){
    outputDiv.innerText += "Error: "+err;
  }
}

// HANDLE INPUT
function handleInput(event){
  if(event.key==="Enter" && inputResolver){
    let val = event.target.value;
    document.getElementById("output").innerText += val + "\n";
    event.target.value="";
    inputResolver(val);
    inputResolver=null;
  }
}

</script>

</body>
</html>
